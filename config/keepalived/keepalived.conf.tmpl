# =============================================================================
# Keepalived Configuration Template for Orion Sentinel HA DNS
# =============================================================================
#
# This template is processed at container startup to inject environment variables.
# Do not edit the generated /etc/keepalived/keepalived.conf directly.
#
# Environment Variables Used:
#   - NODE_ROLE: MASTER or BACKUP
#   - KEEPALIVED_PRIORITY: Higher number = preferred MASTER (e.g., Pi1=200, Pi2=150)
#   - VIP_ADDRESS: The virtual IP that floats between nodes
#   - NETWORK_INTERFACE: Network interface name (e.g., eth0)
#   - VIRTUAL_ROUTER_ID: Must be same on both nodes and unique on LAN (1-255)
#   - VRRP_PASSWORD: Authentication password (must be same on both nodes)
#   - USE_UNICAST_VRRP: true/false - use unicast instead of multicast
#   - PEER_IP: IP address of peer node (for unicast mode)
#
# =============================================================================

global_defs {
    router_id ${NODE_NAME:-orion-dns}
    enable_script_security
    script_user root
}

# Health check script for DNS services
vrrp_script check_dns {
    script "/etc/keepalived/check_dns.sh"
    interval 5        # Check every 5 seconds
    timeout 3         # Script timeout
    weight -20        # Reduce priority by 20 if check fails
    fall 2            # Require 2 failures before marking as down
    rise 2            # Require 2 successes before marking as up
}

# VRRP instance for VIP management
vrrp_instance VI_1 {
    state ${NODE_ROLE:-MASTER}
    interface ${NETWORK_INTERFACE:-eth0}
    virtual_router_id ${VIRTUAL_ROUTER_ID:-51}
    priority ${KEEPALIVED_PRIORITY:-200}
    advert_int 1
    
    # Authentication (must be same on all nodes)
    authentication {
        auth_type PASS
        auth_pass ${VRRP_PASSWORD}
    }
    
    # Unicast peers (if USE_UNICAST_VRRP=true)
    # Multicast is used by default, unicast requires explicit peer configuration
    ${USE_UNICAST_VRRP_CONF}
    
    # Virtual IP address
    virtual_ipaddress {
        ${VIP_ADDRESS}/${VIP_NETMASK:-24}
    }
    
    # Track DNS health
    track_script {
        check_dns
    }
    
    # Notification scripts
    notify_master "/etc/keepalived/notify_master.sh"
    notify_backup "/etc/keepalived/notify_backup.sh"
    notify_fault "/etc/keepalived/notify_fault.sh"
}
