name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read

jobs:
  docker-compose-validation:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test .env file
        run: |
          cat > .env <<EOF
          HOST_IP=192.168.1.100
          VIP_ADDRESS=192.168.1.99
          NETWORK_INTERFACE=eth0
          SUBNET=192.168.1.0/24
          GATEWAY=192.168.1.1
          TZ=UTC
          PIHOLE_PASSWORD=test_password
          PIHOLE_DNS1=127.0.0.1#5335
          PIHOLE_DNS2=127.0.0.1#5335
          PIHOLE_THEME=default-dark
          DEPLOYMENT_MODE=single-pi-ha
          KEEPALIVED_PRIORITY=200
          NODE_ROLE=MASTER
          VRRP_PASSWORD=test_vrrp
          UNBOUND_SMART_PREFETCH=0
          EOF

      - name: Validate main compose.yml
        run: docker compose -f compose.yml config > /dev/null

      - name: Validate all stack compose files
        run: |
          for compose_file in $(find stacks -name "docker-compose*.yml" -o -name "compose.yml"); do
            echo "Validating $compose_file..."
            docker compose -f "$compose_file" config > /dev/null 2>&1 || echo "  ⚠️  Skipped $compose_file (may need specific env vars)"
          done

      - name: Validate wizard compose file
        run: docker compose -f wizard/docker-compose.yml config > /dev/null 2>&1 || echo "⚠️  Wizard compose validation skipped"

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Create yamllint config
        run: |
          cat > .yamllint.yml <<EOF
          extends: default
          rules:
            line-length:
              max: 160
              level: warning
            document-start: disable
            comments:
              min-spaces-from-content: 1
              level: warning
            indentation:
              spaces: 2
              indent-sequences: true
            truthy:
              allowed-values: ['true', 'false', 'on', 'off']
            trailing-spaces: disable
            comments-indentation: disable
          ignore: |
            .github/
            node_modules/
            venv/
          EOF

      - name: Run yamllint
        run: yamllint -c .yamllint.yml . || true

  shellcheck:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck on all scripts
        run: |
          find scripts -name "*.sh" -type f -exec shellcheck --severity=error {} + || true
          find backup -name "*.sh" -type f -exec shellcheck --severity=error {} + || true

  smoke-test:
    name: Smoke Test - Stack Validation
    runs-on: ubuntu-latest
    needs: [docker-compose-validation, yaml-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create dummy .env file
        run: |
          cat > .env <<EOF
          # Dummy configuration for CI testing
          HOST_IP=192.168.1.100
          VIP_ADDRESS=192.168.1.99
          NETWORK_INTERFACE=eth0
          SUBNET=192.168.1.0/24
          GATEWAY=192.168.1.1
          TZ=UTC
          PIHOLE_PASSWORD=test_password_ci_only
          PIHOLE_DNS1=127.0.0.1#5335
          PIHOLE_DNS2=127.0.0.1#5335
          PIHOLE_THEME=default-dark
          DEPLOYMENT_MODE=single-pi-ha
          KEEPALIVED_PRIORITY=200
          NODE_ROLE=MASTER
          VRRP_PASSWORD=test_vrrp_ci
          UNBOUND_SMART_PREFETCH=0
          EOF

      - name: Verify compose configuration
        run: |
          echo "=== Validating compose configuration ==="
          docker compose config --quiet
          echo "✓ Compose configuration is valid"

      - name: Pull container images
        run: |
          echo "=== Pulling container images ==="
          docker compose pull --ignore-pull-failures pihole_primary || true
          echo "✓ Image pull attempted"

      - name: Build custom images
        run: |
          echo "=== Building custom images ==="
          docker compose build unbound_primary || echo "⚠️  Unbound build skipped (config files may be needed)"
          echo "✓ Build step completed"

      - name: Verify services can be created (dry run)
        run: |
          echo "=== Verifying service definitions ==="
          docker compose --profile dns-core config --services
          echo "✓ All services are properly defined"

      - name: Cleanup
        if: always()
        run: |
          docker compose --profile dns-core down -v 2>/dev/null || true
          docker system prune -af --volumes 2>/dev/null || true
