# Keepalived Configuration for PRIMARY Node
# Multi-Node HA Setup
# This node will be the MASTER under normal conditions
#
# NOTE: This template is NOT used at runtime.
# The actual config is generated by entrypoint.sh from environment variables.
# This file is kept for reference only.

global_defs {
    router_id DNS_HA_PRIMARY
    enable_script_security
    script_user root
    
    # Send gratuitous ARP when becoming MASTER
    vrrp_garp_master_refresh 60
    vrrp_garp_master_repeat 3
    vrrp_garp_master_refresh_repeat 2
}

# Health check script to verify local DNS is working
vrrp_script check_dns {
    script "/etc/keepalived/check_dns.sh"
    interval 5      # Check every 5 seconds
    timeout 3       # Script timeout
    weight -20      # Reduce priority by 20 if check fails
    fall 3          # Require 3 failures before marking as failed
    rise 2          # Require 2 successes before marking as recovered
}

# VRRP instance for DNS High Availability
vrrp_instance VI_DNS {
    # Initial state (MASTER or BACKUP)
    # Primary node starts as MASTER
    state MASTER
    
    # Network interface to bind to (from NETWORK_INTERFACE env var)
    interface eth0
    
    # Virtual Router ID (must be same on both nodes, 1-255)
    virtual_router_id 51
    
    # Priority (higher = more likely to be MASTER)
    # Primary: 100, Secondary: 90
    priority 100
    
    # Advertisement interval (seconds)
    advert_int 1
    
    # Authentication (must match on all nodes)
    authentication {
        auth_type PASS
        auth_pass changeme
    }
    
    # Virtual IP address (the floating IP from VIP_ADDRESS env var)
    # Example: 192.168.8.249/24
    virtual_ipaddress {
        192.168.8.249/24 dev eth0
    }
    
    # Use unicast instead of multicast (recommended for managed switches)
    # HOST_IP of this node
    unicast_src_ip 192.168.8.250
    # PEER IP (the other node)
    unicast_peer {
        192.168.8.251
    }
    
    # Track the health check script
    track_script {
        check_dns
    }
    
    # Notification scripts
    notify_master "/etc/keepalived/notify_master.sh"
    notify_backup "/etc/keepalived/notify_backup.sh"
    notify_fault  "/etc/keepalived/notify_fault.sh"
}
