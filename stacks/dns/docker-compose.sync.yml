# Docker Compose file for Multi-Node Sync Service
# Provides automated synchronization between primary and secondary nodes
#
# Features:
# - Continuous Pi-hole gravity database sync
# - Configuration file synchronization
# - Backup replication between nodes
# - Health monitoring integration
#
# Usage:
#   docker compose -f docker-compose.sync.yml up -d

services:
  # Multi-Node Sync Service
  # Runs on both primary and secondary nodes
  # Primary pushes, Secondary pulls
  multinode-sync:
    build:
      context: .
      dockerfile: Dockerfile.sync
    container_name: multinode-sync
    hostname: multinode-sync
    restart: unless-stopped
    profiles:
      - sync
      - two-pi-ha-pi1
      - two-pi-ha-pi2
    environment:
      - NODE_ROLE=${NODE_ROLE:-primary}
      - PEER_IP=${PEER_IP:-}
      - NODE_IP=${NODE_IP:-}
      - SYNC_SSH_USER=${SYNC_SSH_USER:-pi}
      - SYNC_SSH_PORT=${SYNC_SSH_PORT:-22}
      - SYNC_INTERVAL=${SYNC_INTERVAL:-300}
      - REMOTE_REPO_PATH=${REMOTE_REPO_PATH:-/opt/rpi-ha-dns-stack}
      - TZ=${TZ:-UTC}
    volumes:
      # Mount Docker socket for container operations
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount SSH keys for remote access
      - ${SSH_KEY_PATH:-~/.ssh}:/root/.ssh:ro
      # Mount sync script and configuration
      - ./multi-node-sync.sh:/app/multi-node-sync.sh:ro
      - ${REPO_ROOT:-.}/.env:/app/.env:ro
      # Mount backup directory
      - ${BACKUP_DIR:-./backups}:/app/backups
      # Log persistence
      - sync-logs:/app/logs
    networks:
      - dns_net
    healthcheck:
      test: ["CMD", "pgrep", "-f", "multi-node-sync"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    labels:
      - "com.orion-sentinel.service=sync"
      - "com.orion-sentinel.description=Multi-node configuration synchronization"

  # Automated Backup and Sync Service
  # Creates backups and replicates to peer nodes and off-site storage
  backup-sync:
    build:
      context: .
      dockerfile: Dockerfile.sync
    container_name: backup-sync
    hostname: backup-sync
    restart: unless-stopped
    profiles:
      - backup
      - two-pi-ha-pi1
    environment:
      - NODE_ROLE=${NODE_ROLE:-primary}
      - PEER_IP=${PEER_IP:-}
      - BACKUP_DIR=/app/backups
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
      - BACKUP_KEEP_COUNT=${BACKUP_KEEP_COUNT:-10}
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-86400}
      - OFFSITE_BACKUP_ENABLED=${OFFSITE_BACKUP_ENABLED:-false}
      - OFFSITE_TYPE=${OFFSITE_TYPE:-}
      - OFFSITE_PATH=${OFFSITE_PATH:-}
      - NAS_HOST=${NAS_HOST:-}
      - NAS_PATH=${NAS_PATH:-}
      - NAS_USER=${NAS_USER:-}
      - RCLONE_REMOTE=${RCLONE_REMOTE:-}
      - NOTIFICATION_WEBHOOK=${NOTIFICATION_WEBHOOK:-}
      - TZ=${TZ:-UTC}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${SSH_KEY_PATH:-~/.ssh}:/root/.ssh:ro
      - ./automated-sync-backup.sh:/app/automated-sync-backup.sh:ro
      - ${REPO_ROOT:-.}:/app/repo:ro
      - ${BACKUP_DIR:-./backups}:/app/backups
      - backup-logs:/app/logs
      # Mount rclone config if using cloud backup
      - ${RCLONE_CONFIG:-/dev/null}:/root/.config/rclone/rclone.conf:ro
    command: ["bash", "/app/automated-sync-backup.sh", "--daemon"]
    networks:
      - dns_net
    healthcheck:
      test: ["CMD", "test", "-f", "/app/backups/backup.log"]
      interval: 3600s
      timeout: 10s
      retries: 1
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    labels:
      - "com.orion-sentinel.service=backup"
      - "com.orion-sentinel.description=Automated backup and sync service"

  # Self-Healing Service
  # Monitors services and automatically recovers failures
  self-heal:
    build:
      context: .
      dockerfile: Dockerfile.sync
    container_name: self-heal
    hostname: self-heal
    restart: unless-stopped
    profiles:
      - heal
      - single-pi-ha
      - two-pi-ha-pi1
      - two-pi-ha-pi2
    environment:
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-60}
      - MAX_RESTART_ATTEMPTS=${MAX_RESTART_ATTEMPTS:-3}
      - RESTART_COOLDOWN=${RESTART_COOLDOWN:-300}
      - CIRCUIT_BREAKER_THRESHOLD=${CIRCUIT_BREAKER_THRESHOLD:-5}
      - CIRCUIT_BREAKER_TIMEOUT=${CIRCUIT_BREAKER_TIMEOUT:-300}
      - VIP_ADDRESS=${VIP_ADDRESS:-192.168.8.255}
      - TEST_DOMAIN=${TEST_DOMAIN:-google.com}
      - NOTIFICATION_WEBHOOK=${NOTIFICATION_WEBHOOK:-}
      - NOTIFICATION_SIGNAL=${NOTIFICATION_SIGNAL:-false}
      - SIGNAL_API_URL=${SIGNAL_API_URL:-http://localhost:8080}
      - TZ=${TZ:-UTC}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./self-heal.sh:/app/self-heal.sh:ro
      - ${REPO_ROOT:-.}/.env:/app/.env:ro
      - heal-logs:/app/logs
    command: ["bash", "/app/self-heal.sh", "--daemon"]
    networks:
      - dns_net
    # Note: self-heal needs access to host network for VIP check
    # network_mode: host  # Uncomment if VIP checking is required
    healthcheck:
      test: ["CMD", "test", "-f", "/app/logs/self-heal-metrics.json"]
      interval: 120s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    labels:
      - "com.orion-sentinel.service=self-heal"
      - "com.orion-sentinel.description=Service monitoring and auto-recovery"

networks:
  dns_net:
    external: true

volumes:
  sync-logs:
    driver: local
  backup-logs:
    driver: local
  heal-logs:
    driver: local
