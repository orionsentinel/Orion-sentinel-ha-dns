---
###############################################################
#                   Authelia configuration                    #
###############################################################

# Server Configuration
server:
  host: 0.0.0.0
  port: 9091
  path: ""
  read_buffer_size: 4096
  write_buffer_size: 4096
  enable_pprof: false
  enable_expvars: false

# Logging Configuration
log:
  level: info
  format: text
  file_path: ""
  keep_stdout: true

# Theme Configuration
theme: light

# JWT Secret (for signing tokens)
jwt_secret: a_very_important_secret

# Default 2FA Method
default_2fa_method: ""

# TOTP Configuration
totp:
  disable: false
  issuer: rpi-dns-stack
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1
  secret_size: 32

# WebAuthn Configuration (for hardware keys like YubiKey)
webauthn:
  disable: false
  timeout: 60s
  display_name: RPi DNS Stack
  attestation_conveyance_preference: indirect
  user_verification: preferred

# Duo Push API (optional - for Duo 2FA)
# duo_api:
#   disable: true
#   hostname: api-123456789.duosecurity.com
#   integration_key: ABCDEF
#   secret_key: yet_another_very_important_secret

# Access Control Configuration
access_control:
  default_policy: deny
  rules:
    # Allow all authenticated users to access all services
    - domain:
        - "*.local"
        - "192.168.8.250"
        - "192.168.8.251"
        - "192.168.8.252"
      policy: one_factor
      
    # Allow bypass for public endpoints
    - domain:
        - "192.168.8.250"
      resources:
        - "^/api/health$"
      policy: bypass

# Session Configuration
session:
  name: authelia_session
  domain: 192.168.8.250
  same_site: lax
  secret: unsecure_session_secret
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M
  
  # Redis session storage (recommended)
  redis:
    host: authelia-redis
    port: 6379
    database_index: 0

# Regulation (brute force protection)
regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

# Storage Configuration (SQLite)
storage:
  encryption_key: you_must_generate_a_random_string_of_more_than_twenty_chars_and_configure_this
  local:
    path: /config/db.sqlite3

# Notifier Configuration (file-based for now, can be upgraded to SMTP)
notifier:
  disable_startup_check: false
  filesystem:
    filename: /config/notification.txt

# Authentication Backend Configuration
authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m
  
  # File-based user database
  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2id
      iterations: 1
      salt_length: 16
      parallelism: 8
      memory: 64

# Identity Providers (OAuth2/OIDC)
identity_providers:
  oidc:
    hmac_secret: this_is_a_secret_abc123abc123abc
    issuer_private_key: |
      -----BEGIN RSA PRIVATE KEY-----
      # This will be generated by setup script
      -----END RSA PRIVATE KEY-----
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only
    
    clients:
      - id: grafana
        description: Grafana Metrics Dashboard
        secret: '$plaintext$grafana_client_secret_change_me'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - http://192.168.8.250:3000/login/generic_oauth
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - refresh_token
          - authorization_code
        response_types:
          - code
        response_modes:
          - form_post
          - query
          - fragment
        
      - id: pihole
        description: Pi-hole Admin Interface
        secret: '$plaintext$pihole_client_secret_change_me'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - http://192.168.8.251/admin/
          - http://192.168.8.252/admin/
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code
          
      - id: wireguard-ui
        description: WireGuard VPN Management
        secret: '$plaintext$wireguard_client_secret_change_me'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - http://192.168.8.250:5000/oauth2/callback
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code
