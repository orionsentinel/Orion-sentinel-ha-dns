# DNS Log Agent - Example Configuration
# Ships Pi-hole and Unbound logs to Loki on the Security Pi (orion-sentinel-nsm-ai)
#
# OPTIONAL COMPONENT - Only needed for Integrated mode with NSM/AI Pi or CoreSrv
#
# This agent forwards DNS logs to a centralized Loki instance for:
# - Security analysis and correlation
# - Long-term log retention
# - Unified observability
#
# Prerequisites:
# 1. Have a Loki instance running (on NSM Pi or CoreSrv)
# 2. Set LOKI_URL environment variable or update promtail.yml
# 3. Ensure firewall allows traffic to Loki port (default: 3100)
#
# Environment Variables:
#   LOKI_URL - Loki endpoint URL (default: http://192.168.8.100:3100)
#
# Usage:
#   export LOKI_URL=http://your-loki-ip:3100
#   docker compose up -d
#
# NOTE: Core DNS services (Pi-hole, Unbound, Keepalived) do NOT depend on this.
#       They will continue to function normally even if Promtail fails or is not deployed.

version: '3.8'

services:
  # Promtail - Log shipping agent
  promtail:
    image: grafana/promtail:latest
    container_name: dns-log-agent
    restart: unless-stopped
    command:
      - '-config.file=/etc/promtail/promtail.yml'
    volumes:
      - ./promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/log:/var/log:ro
      # Mount Pi-hole log directories (adjust paths as needed)
      - pihole-primary-logs:/var/log/pihole/primary:ro
      - pihole-secondary-logs:/var/log/pihole/secondary:ro
      # Mount Unbound log directories (if using file logging)
      - unbound-primary-logs:/var/log/unbound/primary:ro
      - unbound-secondary-logs:/var/log/unbound/secondary:ro
    environment:
      - LOKI_URL=${LOKI_URL:-http://192.168.8.100:3100}  # Security Pi Loki endpoint
    networks:
      - dns_net

  # Alternative: Fluentd for more complex log processing
  # Uncomment if you need log parsing, filtering, or enrichment
  #
  # fluentd:
  #   image: fluent/fluentd:latest
  #   container_name: dns-log-processor
  #   restart: unless-stopped
  #   volumes:
  #     - ./fluentd.conf:/fluentd/etc/fluent.conf:ro
  #     - pihole-primary-logs:/var/log/pihole/primary:ro
  #     - pihole-secondary-logs:/var/log/pihole/secondary:ro
  #   environment:
  #     - LOKI_URL=${LOKI_URL:-http://192.168.8.100:3100}
  #   networks:
  #     - dns_net

volumes:
  # These volumes should match the volumes used by Pi-hole and Unbound containers
  pihole-primary-logs:
    external: true
  pihole-secondary-logs:
    external: true
  unbound-primary-logs:
    external: true
  unbound-secondary-logs:
    external: true

networks:
  dns_net:
    external: true
