# Pi DNS Agent - Docker Compose Configuration
# Ships Pi-hole and Unbound logs to Dell CoreSrv Loki (Integrated mode)
#
# OPTIONAL COMPONENT - Only needed for Integrated mode with CoreSrv
#
# This is part of the Single Pane of Glass (SPoG) architecture where:
# - Dell CoreSrv hosts centralized observability (Loki, Grafana, Prometheus, Traefik, Authelia)
# - Pi DNS node runs this Promtail agent to ship logs to Dell
# - NetSec Pi runs a similar agent for security logs
#
# Prerequisites:
# 1. Copy promtail-config.example.yml to promtail-config.yml
# 2. Update the Dell CoreSrv IP in promtail-config.yml OR set LOKI_URL environment variable
# 3. Ensure firewall allows Pi DNS -> Dell port 3100
# 4. Set LOKI_URL in .env or export it before running
#
# Environment Variables:
#   LOKI_URL - Loki endpoint URL (default: http://192.168.8.100:3100)
#   CORESRV_IP - CoreSrv IP address (alternative to full LOKI_URL)
#
# Usage:
#   # Option 1: Using environment variable
#   export LOKI_URL=http://your-coresrv-ip:3100
#   docker compose up -d
#
#   # Option 2: Using .env file
#   echo "LOKI_URL=http://your-coresrv-ip:3100" >> .env
#   docker compose up -d
#
# NOTE: Core DNS services (Pi-hole, Unbound, Keepalived) do NOT depend on this.
#       They will continue to function normally even if Promtail fails or is not deployed.

version: '3.8'

services:
  # Promtail - Log shipping agent to Dell CoreSrv
  promtail:
    image: grafana/promtail:2.9.5
    container_name: pi-dns-agent
    restart: unless-stopped

    command:
      - '-config.file=/etc/promtail/config.yml'

    volumes:
      # Promtail configuration
      - ./promtail-config.yml:/etc/promtail/config.yml:ro

      # System logs
      - /var/log:/var/log:ro

      # Docker container logs
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Pi-hole logs (if using named volumes)
      # Uncomment and adjust based on your Pi-hole deployment
      # - pihole-logs:/var/log/pihole:ro

      # Unbound logs (if using named volumes)
      # Uncomment and adjust based on your Unbound deployment
      # - unbound-logs:/var/log/unbound:ro

    environment:
      # Override Loki URL via environment variable (optional)
      # This is useful for testing without modifying the config file
      - LOKI_URL=${LOKI_URL:-http://192.168.8.100:3100}

    ports:
      # Promtail metrics endpoint (optional, for monitoring)
      - "9080:9080"

    networks:
      - dns_net

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9080/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Resource limits for Raspberry Pi
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

    labels:
      # Metadata labels
      - "com.orion.stack=dns-ha"
      - "com.orion.component=log-agent"
      - "com.orion.role=observability"
      - "com.orion.mode=spog"

# Networks
networks:
  # Connect to the DNS stack network to access container logs
  dns_net:
    external: true
    # If dns_net doesn't exist, create it with:
    # docker network create dns_net

# Volumes (optional - uncomment if using named volumes)
# volumes:
#   pihole-logs:
#     external: true
#   unbound-logs:
#     external: true
