# Keepalived Configuration for Pi1 (MASTER) - Two-Pi HA Mode
# =============================================================
#
# USAGE:
# 1. Copy this file to your Pi1
# 2. Replace placeholder values with your actual configuration:
#    - <VRRP_PASSWORD>: Your VRRP authentication password
#    - 192.168.8.250: Your Pi1 IP address (HOST_IP on Pi1)
#    - 192.168.8.251: Your Pi2 IP address
#    - 192.168.8.249: Your VIP address
#    - eth0: Your network interface
#
# 3. Mount this file into the keepalived container:
#    volumes:
#      - ./keepalived.pi1.conf:/etc/keepalived/keepalived.conf:ro
#
# Or use environment variable substitution with envsubst before mounting.

global_defs {
    router_id pi1-dns
    max_auto_priority 100
    
    # Send gratuitous ARP when becoming MASTER
    vrrp_garp_master_refresh 60
    vrrp_garp_master_repeat 3
    vrrp_garp_master_refresh_repeat 2
}

# Health check script to verify DNS is working
vrrp_script check_dns {
    script "/etc/keepalived/check_dns.sh"
    interval 5
    timeout 3
    weight -20
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    # Pi1 is the MASTER (primary)
    state MASTER
    
    # Network interface (usually eth0 on Raspberry Pi)
    interface eth0
    
    # Virtual Router ID - must be the same on both Pis (1-255)
    virtual_router_id 51
    
    # Priority - higher value = more likely to be MASTER
    # Pi1: 100, Pi2: 90
    priority 100
    
    # VRRP advertisement interval (seconds)
    advert_int 1

    # Authentication - must be identical on both Pis
    authentication {
        auth_type PASS
        auth_pass <VRRP_PASSWORD>
    }

    # Unicast VRRP between the two Pis (recommended over multicast)
    # This Pi's IP address
    unicast_src_ip 192.168.8.250
    # Peer Pi's IP address
    unicast_peer {
        192.168.8.251
    }

    # Virtual IP address - the floating DNS VIP
    # This IP moves between Pi1 and Pi2 based on which is MASTER
    virtual_ipaddress {
        192.168.8.249/24 dev eth0
    }
    
    # Track the DNS health check script
    track_script {
        check_dns
    }
    
    # Notification scripts (optional - for alerting)
    notify_master "/etc/keepalived/notify_master.sh"
    notify_backup "/etc/keepalived/notify_backup.sh"
    notify_fault  "/etc/keepalived/notify_fault.sh"
}
